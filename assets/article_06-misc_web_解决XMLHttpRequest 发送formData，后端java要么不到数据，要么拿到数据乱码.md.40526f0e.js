import{_ as s,o as a,c as n,B as l}from"./app.5c1a2e9f.js";const E=JSON.parse('{"title":"解决XMLHttpRequest发送formData，java后端无法正确拿到数据问题","description":"","frontmatter":{"title":"解决XMLHttpRequest发送formData，java后端无法正确拿到数据问题","author":"Potter","date":"2022-04-23T16:21:03.000Z","tags":["乱码"],"categories":["web"]},"headers":[],"relativePath":"article/06-misc/web/解决XMLHttpRequest 发送formData，后端java要么不到数据，要么拿到数据乱码.md","lastUpdated":1717737287000}'),o={name:"article/06-misc/web/解决XMLHttpRequest 发送formData，后端java要么不到数据，要么拿到数据乱码.md"},p=l(`<h1 id="解决xmlhttprequest发送formdata-java后端无法正确拿到数据问题" tabindex="-1">解决XMLHttpRequest发送formData，java后端无法正确拿到数据问题 <a class="header-anchor" href="#解决xmlhttprequest发送formdata-java后端无法正确拿到数据问题" aria-hidden="true">#</a></h1><h1 id="故事背景" tabindex="-1">故事背景 <a class="header-anchor" href="#故事背景" aria-hidden="true">#</a></h1><p>购物车清单导出至邮箱，由于之前是用客户端做的，现在需要前端也实现这一个功能。具体功能其实就是：一个请求同时传递参数（邮箱、文件名等）+ 清单文件</p><p>接下来抓包看客户端的请求数据</p><h1 id="正常请求webform内容" tabindex="-1">正常请求WebForm内容 <a class="header-anchor" href="#正常请求webform内容" aria-hidden="true">#</a></h1><p><img src="https://cdn.jsdelivr.net/gh/yxw007/BlogPicBed@master//img/20240108161310.png" alt=""></p><p>看到如上抓包信息，立马想到其实就是一个http请求，只是数据通过formData传过去的</p><h1 id="示例代码" tabindex="-1">示例代码 <a class="header-anchor" href="#示例代码" aria-hidden="true">#</a></h1><div class="language-bash"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki material-theme-palenight" tabindex="0"><code><span class="line"><span style="color:#FFCB6B;">const</span><span style="color:#BABED8;"> </span><span style="color:#C3E88D;">xhr</span><span style="color:#BABED8;"> </span><span style="color:#C3E88D;">=</span><span style="color:#BABED8;"> </span><span style="color:#C3E88D;">new</span><span style="color:#BABED8;"> </span><span style="color:#C3E88D;">XMLHttpRequest</span><span style="color:#89DDFF;">();</span></span>
<span class="line"><span style="color:#BABED8;">	</span><span style="color:#FFCB6B;">xhr.responseType</span><span style="color:#BABED8;"> </span><span style="color:#C3E88D;">=</span><span style="color:#BABED8;"> </span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">json</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#BABED8;">	</span><span style="color:#FFCB6B;">xhr.setRequestHeader(</span><span style="color:#FFCB6B;">&quot;Content-Type&quot;</span><span style="color:#FFCB6B;">,</span><span style="color:#BABED8;"> </span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">multipart/form-data</span><span style="color:#89DDFF;">&quot;</span><span style="color:#BABED8;">)</span><span style="color:#89DDFF;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#BABED8;">	</span><span style="color:#FFCB6B;">const</span><span style="color:#BABED8;"> </span><span style="color:#C3E88D;">formData</span><span style="color:#BABED8;"> </span><span style="color:#C3E88D;">=</span><span style="color:#BABED8;"> </span><span style="color:#C3E88D;">new</span><span style="color:#BABED8;"> </span><span style="color:#C3E88D;">FormData</span><span style="color:#89DDFF;">();</span></span>
<span class="line"><span style="color:#BABED8;">	</span><span style="color:#FFCB6B;">formData.append(</span><span style="color:#FFCB6B;">&quot;mail_address&quot;</span><span style="color:#FFCB6B;">,</span><span style="color:#BABED8;"> </span><span style="color:#C3E88D;">email</span><span style="color:#BABED8;">)</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#BABED8;">	</span><span style="color:#FFCB6B;">formData.append(</span><span style="color:#FFCB6B;">&quot;design_name&quot;</span><span style="color:#FFCB6B;">,</span><span style="color:#BABED8;"> </span><span style="color:#C3E88D;">fileName</span><span style="color:#BABED8;">)</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#BABED8;">	</span><span style="color:#FFCB6B;">formData.append(</span><span style="color:#FFCB6B;">&quot;ext&quot;</span><span style="color:#FFCB6B;">,</span><span style="color:#BABED8;"> </span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">.xlsx</span><span style="color:#89DDFF;">&quot;</span><span style="color:#BABED8;">)</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#BABED8;">	</span><span style="color:#FFCB6B;">formData.append(</span><span style="color:#FFCB6B;">&quot;token&quot;</span><span style="color:#FFCB6B;">,</span><span style="color:#BABED8;"> </span><span style="color:#C3E88D;">token</span><span style="color:#BABED8;">)</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#BABED8;">	</span><span style="color:#FFCB6B;">formData.append(</span><span style="color:#FFCB6B;">&quot;file&quot;</span><span style="color:#FFCB6B;">,</span><span style="color:#BABED8;"> </span><span style="color:#C3E88D;">new</span><span style="color:#BABED8;"> </span><span style="color:#C3E88D;">Blob</span><span style="color:#89DDFF;">([</span><span style="color:#BABED8;">buffer</span><span style="color:#89DDFF;">])</span><span style="color:#C3E88D;">,</span><span style="color:#BABED8;"> </span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">file.dat</span><span style="color:#89DDFF;">&quot;</span><span style="color:#BABED8;">)</span><span style="color:#89DDFF;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#BABED8;">	</span><span style="color:#FFCB6B;">xhr.onload</span><span style="color:#BABED8;"> </span><span style="color:#C3E88D;">=</span><span style="color:#BABED8;"> </span><span style="color:#C3E88D;">function</span><span style="color:#BABED8;"> () {</span></span>
<span class="line"><span style="color:#BABED8;">		</span><span style="color:#FFCB6B;">const</span><span style="color:#BABED8;"> </span><span style="color:#C3E88D;">res</span><span style="color:#BABED8;"> </span><span style="color:#C3E88D;">=</span><span style="color:#BABED8;"> </span><span style="color:#C3E88D;">xhr.response</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#BABED8;">		</span><span style="color:#89DDFF;font-style:italic;">if</span><span style="color:#BABED8;"> </span><span style="color:#89DDFF;">(</span><span style="color:#FFCB6B;">res?.status</span><span style="color:#BABED8;"> </span><span style="color:#C3E88D;">===</span><span style="color:#BABED8;"> </span><span style="color:#F78C6C;">0</span><span style="color:#89DDFF;">)</span><span style="color:#BABED8;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#BABED8;">			</span><span style="color:#FFCB6B;">callback(true</span><span style="color:#BABED8;">)</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#BABED8;">		</span><span style="color:#89DDFF;">}</span><span style="color:#BABED8;"> </span><span style="color:#89DDFF;font-style:italic;">else</span><span style="color:#BABED8;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#BABED8;">			</span><span style="color:#FFCB6B;">callback(false,</span><span style="color:#BABED8;"> </span><span style="color:#C3E88D;">res?.info</span><span style="color:#BABED8;">)</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#BABED8;">		</span><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#BABED8;">	}</span><span style="color:#89DDFF;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#BABED8;">	</span><span style="color:#FFCB6B;">xhr.onerror</span><span style="color:#BABED8;"> </span><span style="color:#C3E88D;">=</span><span style="color:#BABED8;"> </span><span style="color:#C3E88D;">function</span><span style="color:#BABED8;"> </span><span style="color:#C3E88D;">error</span><span style="color:#89DDFF;">(</span><span style="color:#FFCB6B;">e</span><span style="color:#89DDFF;">)</span><span style="color:#BABED8;"> </span><span style="color:#C3E88D;">{</span></span>
<span class="line"><span style="color:#BABED8;">		</span><span style="color:#FFCB6B;">callback(false,</span><span style="color:#BABED8;"> </span><span style="color:#C3E88D;">e</span><span style="color:#BABED8;">)</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#BABED8;">	}</span><span style="color:#89DDFF;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#BABED8;">	</span><span style="color:#FFCB6B;">xhr.open(</span><span style="color:#FFCB6B;">&quot;post&quot;</span><span style="color:#FFCB6B;">,</span><span style="color:#BABED8;"> </span><span style="color:#C3E88D;">url</span><span style="color:#BABED8;">)</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#BABED8;">	</span><span style="color:#FFCB6B;">xhr.send(formData</span><span style="color:#BABED8;">)</span><span style="color:#89DDFF;">;</span></span>
<span class="line"></span></code></pre></div><blockquote><p>此时：问题出现了，后端java要么拿到数据乱码，要不拿到数据为空</p></blockquote><h1 id="思考和解决问题的过程" tabindex="-1">思考和解决问题的过程 <a class="header-anchor" href="#思考和解决问题的过程" aria-hidden="true">#</a></h1><ol><li><p>乱码：将Content-type 设置为text/plain;charset=”UTF8”（测试：不对，好像拿不到数据，不是这问题）</p></li><li><p>难道formData的请求写错了？仔细看了一下好像没错，难道是传文件影响了？注释掉file 仍然不行</p></li><li><p>实在想不到什么问题了，直接copy fromData 示例，文件也不传。</p><div class="language-jsx"><button title="Copy Code" class="copy"></button><span class="lang">jsx</span><pre class="shiki material-theme-palenight" tabindex="0"><code><span class="line"><span style="color:#C792EA;">var</span><span style="color:#BABED8;"> formData </span><span style="color:#89DDFF;">=</span><span style="color:#BABED8;"> </span><span style="color:#89DDFF;">new</span><span style="color:#BABED8;"> </span><span style="color:#82AAFF;">FormData</span><span style="color:#BABED8;">()</span><span style="color:#89DDFF;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#BABED8;">formData</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">append</span><span style="color:#BABED8;">(</span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">username</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">,</span><span style="color:#BABED8;"> </span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">Groucho</span><span style="color:#89DDFF;">&quot;</span><span style="color:#BABED8;">)</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#BABED8;">formData</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">append</span><span style="color:#BABED8;">(</span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">accountnum</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">,</span><span style="color:#BABED8;"> </span><span style="color:#F78C6C;">123456</span><span style="color:#BABED8;">)</span><span style="color:#89DDFF;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#C792EA;">var</span><span style="color:#BABED8;"> request </span><span style="color:#89DDFF;">=</span><span style="color:#BABED8;"> </span><span style="color:#89DDFF;">new</span><span style="color:#BABED8;"> </span><span style="color:#82AAFF;">XMLHttpRequest</span><span style="color:#BABED8;">()</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#BABED8;">request</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">open</span><span style="color:#BABED8;">(</span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">POST</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">,</span><span style="color:#BABED8;"> url)</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#BABED8;">request</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">send</span><span style="color:#BABED8;">(formData)</span><span style="color:#89DDFF;">;</span></span>
<span class="line"></span></code></pre></div><blockquote><p>这样后端拿到了...</p></blockquote></li><li><p>逐步排查后，其实就是xhr.setRequestHeader(&quot;Content-Type&quot;, &quot;multipart/form-data&quot;); 这句代码惹的活，直接去掉就可以了。（具体原因不明，如有小伙伴知道，烦请告诉我）</p></li></ol><h1 id="总结" tabindex="-1">总结 <a class="header-anchor" href="#总结" aria-hidden="true">#</a></h1><ul><li>如果实在找不到问题，将直接使用官方提供的极简示例测试，然后逐步还原真实场景，这样可快速定位问题</li></ul><h1 id="参考文献" tabindex="-1">参考文献 <a class="header-anchor" href="#参考文献" aria-hidden="true">#</a></h1><ul><li><a href="https://developer.mozilla.org/en-US/docs/Web/API/FormData/Using_FormData_Objects" target="_blank" rel="noreferrer">https://developer.mozilla.org/en-US/docs/Web/API/FormData/Using_FormData_Objects</a></li></ul><blockquote><p>以上：如发现有问题，欢迎留言指出，我及时更正</p></blockquote>`,17),e=[p];function t(r,c,D,B,y,F){return a(),n("div",null,e)}const A=s(o,[["render",t]]);export{E as __pageData,A as default};
