import{_ as s,o as a,c as n,B as l}from"./app.69f741f6.js";const A=JSON.parse('{"title":"初始化不统一控制好，引发的血案","description":"","frontmatter":{"title":"初始化不统一控制好，引发的血案","author":"Potter","date":"2022-05-12 18:35","tags":["编程血案"],"categories":["编程血案"]},"headers":[],"relativePath":"article/06-misc/tragedy/初始化不统一控制好，引发的血案.md","lastUpdated":1712745201000}'),p={name:"article/06-misc/tragedy/初始化不统一控制好，引发的血案.md"},o=l(`<h1 id="初始化不统一控制好-引发的血案" tabindex="-1">初始化不统一控制好，引发的血案 <a class="header-anchor" href="#初始化不统一控制好-引发的血案" aria-hidden="true">#</a></h1><h1 id="问题描述" tabindex="-1">问题描述： <a class="header-anchor" href="#问题描述" aria-hidden="true">#</a></h1><p>多线程下载：简单多个任务下载无问题，大批量下载任务，出现部分任务丢失问题</p><h1 id="问题现象" tabindex="-1">问题现象： <a class="header-anchor" href="#问题现象" aria-hidden="true">#</a></h1><ul><li>问题 1：添加完任务后，update 不自动执行，需要通过直接调用 Update 才执行（没有深究其原因，就先临时这么处理了，于是就引发后面的诡异问题）</li><li>问题 2：简单多个任务下载无问题，大批量下载任务，出现部分任务丢失问题</li></ul><h1 id="思考问题-2" tabindex="-1">思考问题 2： <a class="header-anchor" href="#思考问题-2" aria-hidden="true">#</a></h1><p>既然不大量下载就没有问题，那就弄个最简单的批量下载来复现问题，接下来就发现了以下新问题 3</p><ul><li><strong>问题 3：共享队列刚刚添加完 item，update 的时候队列总是为空</strong></li></ul><h1 id="思考问题-3" tabindex="-1">思考问题 3 <a class="header-anchor" href="#思考问题-3" aria-hidden="true">#</a></h1><ul><li>思考 1：多线程导致数据不一致问题，添加在一个线程，update 在另外一个线程（已添加了锁，不应该是这个问题）</li><li>思考 2：哪里把数据又删除了 或者把队列重置了（仔细检查了一遍删除相关代码无问题，把所有队列赋值的地方加个断点调试一下，发现只有 1 处地方，运行发现执行了 2 次，原因：CDLWork 对象 init 两次导致）</li></ul><p>回顾一下代码</p><h1 id="场景代码" tabindex="-1">场景代码 <a class="header-anchor" href="#场景代码" aria-hidden="true">#</a></h1><ul><li><p>CDLWork</p><div class="language-csharp"><button title="Copy Code" class="copy"></button><span class="lang">csharp</span><pre class="shiki material-theme-palenight" tabindex="0"><code><span class="line"><span style="color:#C792EA;">public</span><span style="color:#BABED8;"> </span><span style="color:#FFCB6B;">class</span><span style="color:#BABED8;"> </span><span style="color:#FFCB6B;">CDLWork</span><span style="color:#BABED8;"> </span><span style="color:#89DDFF;">:</span><span style="color:#BABED8;"> </span><span style="color:#FFCB6B;">Singleton</span><span style="color:#89DDFF;">&lt;</span><span style="color:#FFCB6B;">CDLWork</span><span style="color:#89DDFF;">&gt;,</span><span style="color:#BABED8;"> </span><span style="color:#FFCB6B;">IInit</span><span style="color:#89DDFF;">,</span><span style="color:#BABED8;"> </span><span style="color:#FFCB6B;">IDispose</span></span>
<span class="line"><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#BABED8;">	</span><span style="color:#C792EA;">private</span><span style="color:#BABED8;"> </span><span style="color:#FFCB6B;">Queue</span><span style="color:#89DDFF;">&lt;</span><span style="color:#FFCB6B;">SDLTaskItem</span><span style="color:#89DDFF;">&gt;</span><span style="color:#BABED8;"> </span><span style="color:#FFCB6B;">m_waitItems</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#BABED8;">	</span><span style="color:#C792EA;">private</span><span style="color:#BABED8;"> </span><span style="color:#C792EA;">readonly</span><span style="color:#BABED8;"> </span><span style="color:#89DDFF;">object</span><span style="color:#BABED8;"> </span><span style="color:#FFCB6B;">m_object</span><span style="color:#BABED8;"> </span><span style="color:#89DDFF;">=</span><span style="color:#BABED8;"> </span><span style="color:#89DDFF;">new</span><span style="color:#BABED8;"> </span><span style="color:#89DDFF;">object();</span></span>
<span class="line"></span>
<span class="line"><span style="color:#BABED8;">	</span><span style="color:#C792EA;">public</span><span style="color:#BABED8;"> </span><span style="color:#89DDFF;">void</span><span style="color:#BABED8;"> </span><span style="color:#82AAFF;">Init</span><span style="color:#89DDFF;">()</span></span>
<span class="line"><span style="color:#BABED8;">  </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#BABED8;">		m_waitItems </span><span style="color:#89DDFF;">=</span><span style="color:#BABED8;"> </span><span style="color:#89DDFF;">new</span><span style="color:#BABED8;"> </span><span style="color:#FFCB6B;">KPriorityQueue</span><span style="color:#89DDFF;">&lt;int,</span><span style="color:#BABED8;"> </span><span style="color:#FFCB6B;">SDLTaskItem</span><span style="color:#89DDFF;">,</span><span style="color:#BABED8;"> </span><span style="color:#89DDFF;">int&gt;();</span></span>
<span class="line"><span style="color:#BABED8;">	</span><span style="color:#89DDFF;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#BABED8;">	</span><span style="color:#C792EA;">public</span><span style="color:#BABED8;"> </span><span style="color:#89DDFF;">void</span><span style="color:#BABED8;"> </span><span style="color:#82AAFF;">AddTask</span><span style="color:#89DDFF;">(</span><span style="color:#FFCB6B;">SDLTaskItem</span><span style="color:#BABED8;"> </span><span style="color:#FFCB6B;">taskItem</span><span style="color:#89DDFF;">)</span></span>
<span class="line"><span style="color:#BABED8;">	</span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#89DDFF;font-style:italic;">			</span><span style="color:#676E95;font-style:italic;">//1.添加任务</span></span>
<span class="line"><span style="color:#BABED8;">	    </span><span style="color:#89DDFF;font-style:italic;">lock</span><span style="color:#BABED8;"> </span><span style="color:#89DDFF;">(</span><span style="color:#BABED8;">m_object</span><span style="color:#89DDFF;">)</span></span>
<span class="line"><span style="color:#BABED8;">	    </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#BABED8;">	        m_waitItems</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">Enqueue</span><span style="color:#89DDFF;">(</span><span style="color:#BABED8;">taskItem</span><span style="color:#89DDFF;">);</span></span>
<span class="line"><span style="color:#BABED8;">	    </span><span style="color:#89DDFF;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#89DDFF;font-style:italic;">			</span><span style="color:#676E95;font-style:italic;">//添加完任务后，外层update执行刷新不到任务，需要通过直接调用Update才正常</span></span>
<span class="line"><span style="color:#BABED8;">			</span><span style="color:#82AAFF;">Update</span><span style="color:#89DDFF;">();</span></span>
<span class="line"><span style="color:#BABED8;">	</span><span style="color:#89DDFF;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#89DDFF;font-style:italic;">	</span><span style="color:#676E95;font-style:italic;">//2.外层调用Update刷新任务</span></span>
<span class="line"><span style="color:#BABED8;">	</span><span style="color:#C792EA;">public</span><span style="color:#BABED8;"> </span><span style="color:#89DDFF;">void</span><span style="color:#BABED8;"> </span><span style="color:#82AAFF;">Update</span><span style="color:#89DDFF;">()</span></span>
<span class="line"><span style="color:#BABED8;">  </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#BABED8;">			</span><span style="color:#82AAFF;">__OnUpdate</span><span style="color:#89DDFF;">();</span></span>
<span class="line"><span style="color:#BABED8;">  </span><span style="color:#89DDFF;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#BABED8;">	</span><span style="color:#C792EA;">private</span><span style="color:#BABED8;"> </span><span style="color:#89DDFF;">void</span><span style="color:#BABED8;"> </span><span style="color:#82AAFF;">__OnUpdate</span><span style="color:#89DDFF;">()</span></span>
<span class="line"><span style="color:#BABED8;">  </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#BABED8;">      </span><span style="color:#89DDFF;font-style:italic;">lock</span><span style="color:#BABED8;"> </span><span style="color:#89DDFF;">(</span><span style="color:#BABED8;">m_object</span><span style="color:#89DDFF;">)</span></span>
<span class="line"><span style="color:#BABED8;">      </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#BABED8;">          </span><span style="color:#82AAFF;">__AutoAddToExcuteList</span><span style="color:#89DDFF;">();</span></span>
<span class="line"><span style="color:#BABED8;">          </span><span style="color:#82AAFF;">__StartMultiTask</span><span style="color:#89DDFF;">();</span></span>
<span class="line"><span style="color:#BABED8;">      </span><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#BABED8;">  </span><span style="color:#89DDFF;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#BABED8;">	</span><span style="color:#C792EA;">private</span><span style="color:#BABED8;"> </span><span style="color:#89DDFF;">void</span><span style="color:#BABED8;"> </span><span style="color:#82AAFF;">__StartMultiTask</span><span style="color:#89DDFF;">()</span></span>
<span class="line"><span style="color:#BABED8;">  </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#89DDFF;font-style:italic;">		  </span><span style="color:#676E95;font-style:italic;">//3.问题：在此发现m_waitItems为空</span></span>
<span class="line"><span style="color:#BABED8;">      </span><span style="color:#89DDFF;font-style:italic;">if</span><span style="color:#BABED8;"> </span><span style="color:#89DDFF;">(</span><span style="color:#BABED8;">m_excuteItems</span><span style="color:#89DDFF;">.</span><span style="color:#BABED8;">Count </span><span style="color:#89DDFF;">&lt;=</span><span style="color:#BABED8;"> </span><span style="color:#F78C6C;">0</span><span style="color:#89DDFF;">)</span></span>
<span class="line"><span style="color:#BABED8;">      </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#BABED8;">          </span><span style="color:#89DDFF;font-style:italic;">return</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#BABED8;">      </span><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#BABED8;">	</span><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#89DDFF;">}</span></span>
<span class="line"></span></code></pre></div></li></ul><h1 id="具体原因" tabindex="-1">具体原因： <a class="header-anchor" href="#具体原因" aria-hidden="true">#</a></h1><ul><li><p>CMApplication</p><div class="language-csharp"><button title="Copy Code" class="copy"></button><span class="lang">csharp</span><pre class="shiki material-theme-palenight" tabindex="0"><code><span class="line"><span style="color:#C792EA;">public</span><span style="color:#BABED8;"> </span><span style="color:#FFCB6B;">class</span><span style="color:#BABED8;"> </span><span style="color:#FFCB6B;">CMApplication</span><span style="color:#BABED8;"> </span><span style="color:#89DDFF;">:</span><span style="color:#BABED8;"> </span><span style="color:#FFCB6B;">Singleton</span><span style="color:#89DDFF;">&lt;</span><span style="color:#FFCB6B;">CMApplication</span><span style="color:#89DDFF;">&gt;,</span><span style="color:#BABED8;"> </span><span style="color:#FFCB6B;">IInit</span><span style="color:#89DDFF;">,</span><span style="color:#BABED8;"> </span><span style="color:#FFCB6B;">IDispose</span></span>
<span class="line"><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#BABED8;">	</span><span style="color:#C792EA;">public</span><span style="color:#BABED8;"> </span><span style="color:#89DDFF;">void</span><span style="color:#BABED8;"> </span><span style="color:#82AAFF;">Init</span><span style="color:#89DDFF;">()</span></span>
<span class="line"><span style="color:#BABED8;">	</span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#BABED8;">			</span><span style="color:#89DDFF;">..</span><span style="color:#BABED8;">.</span></span>
<span class="line"><span style="color:#BABED8;">	    m_dlWork </span><span style="color:#89DDFF;">=</span><span style="color:#BABED8;"> </span><span style="color:#89DDFF;">new</span><span style="color:#BABED8;"> </span><span style="color:#FFCB6B;">CDLWork</span><span style="color:#89DDFF;">();</span></span>
<span class="line"><span style="color:#BABED8;">	    m_dlWork</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">Init</span><span style="color:#89DDFF;">();</span></span>
<span class="line"></span>
<span class="line"><span style="color:#BABED8;">	    </span><span style="color:#89DDFF;font-style:italic;">if</span><span style="color:#BABED8;"> </span><span style="color:#89DDFF;">(null</span><span style="color:#BABED8;"> </span><span style="color:#89DDFF;">==</span><span style="color:#BABED8;"> m_mainThread</span><span style="color:#89DDFF;">)</span></span>
<span class="line"><span style="color:#BABED8;">	    </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#BABED8;">	        m_bFlag </span><span style="color:#89DDFF;">=</span><span style="color:#BABED8;"> </span><span style="color:#FF9CAC;">true</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#BABED8;">	        m_mainThread </span><span style="color:#89DDFF;">=</span><span style="color:#BABED8;"> </span><span style="color:#89DDFF;">new</span><span style="color:#BABED8;"> </span><span style="color:#FFCB6B;">Thread</span><span style="color:#89DDFF;">(</span><span style="color:#BABED8;">__Run</span><span style="color:#89DDFF;">);</span></span>
<span class="line"><span style="color:#BABED8;">	        m_mainThread</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">Start</span><span style="color:#89DDFF;">();</span></span>
<span class="line"><span style="color:#BABED8;">	    </span><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#BABED8;">	</span><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#BABED8;">	</span><span style="color:#C792EA;">private</span><span style="color:#BABED8;"> </span><span style="color:#89DDFF;">void</span><span style="color:#BABED8;"> </span><span style="color:#82AAFF;">__Run</span><span style="color:#89DDFF;">()</span></span>
<span class="line"><span style="color:#BABED8;">    </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#BABED8;">        </span><span style="color:#89DDFF;font-style:italic;">while</span><span style="color:#BABED8;"> </span><span style="color:#89DDFF;">(</span><span style="color:#BABED8;">m_bFlag</span><span style="color:#89DDFF;">)</span></span>
<span class="line"><span style="color:#BABED8;">        </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#BABED8;">	          </span><span style="color:#89DDFF;">..</span><span style="color:#BABED8;">.</span></span>
<span class="line"><span style="color:#BABED8;">            m_dlWork</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">Update</span><span style="color:#89DDFF;">();</span></span>
<span class="line"><span style="color:#BABED8;">						</span><span style="color:#89DDFF;">..</span><span style="color:#BABED8;">.</span></span>
<span class="line"><span style="color:#BABED8;">            Thread</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">Sleep</span><span style="color:#89DDFF;">(</span><span style="color:#BABED8;">N_MAIN_THREAD_DELAY</span><span style="color:#89DDFF;">);</span></span>
<span class="line"><span style="color:#BABED8;">        </span><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#BABED8;">    </span><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#89DDFF;">}</span></span>
<span class="line"></span></code></pre></div></li><li><p>Program</p><div class="language-csharp"><button title="Copy Code" class="copy"></button><span class="lang">csharp</span><pre class="shiki material-theme-palenight" tabindex="0"><code><span class="line"><span style="color:#C792EA;">static</span><span style="color:#BABED8;"> </span><span style="color:#FFCB6B;">class</span><span style="color:#BABED8;"> </span><span style="color:#FFCB6B;">Program</span></span>
<span class="line"><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#BABED8;">	</span><span style="color:#C792EA;">static</span><span style="color:#BABED8;"> </span><span style="color:#89DDFF;">void</span><span style="color:#BABED8;"> </span><span style="color:#82AAFF;">Main</span><span style="color:#89DDFF;">()</span></span>
<span class="line"><span style="color:#BABED8;">  </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#BABED8;">    </span><span style="color:#82AAFF;">Init</span><span style="color:#89DDFF;">();</span></span>
<span class="line"><span style="color:#BABED8;">	</span><span style="color:#89DDFF;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#BABED8;">	</span><span style="color:#C792EA;">static</span><span style="color:#BABED8;"> </span><span style="color:#89DDFF;">void</span><span style="color:#BABED8;"> </span><span style="color:#82AAFF;">Init</span><span style="color:#89DDFF;">()</span></span>
<span class="line"><span style="color:#BABED8;">  </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#89DDFF;font-style:italic;">      </span><span style="color:#676E95;font-style:italic;">//1.系统初始化</span></span>
<span class="line"><span style="color:#BABED8;">      CMApplication</span><span style="color:#89DDFF;">.</span><span style="color:#BABED8;">Instance</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">Init</span><span style="color:#89DDFF;">();</span></span>
<span class="line"></span>
<span class="line"><span style="color:#89DDFF;font-style:italic;">      </span><span style="color:#676E95;font-style:italic;">//2.Case初始化</span></span>
<span class="line"><span style="color:#BABED8;">      CDLWork</span><span style="color:#89DDFF;">.</span><span style="color:#BABED8;">Instance</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">Init</span><span style="color:#89DDFF;">();</span></span>
<span class="line"><span style="color:#BABED8;">  </span><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#89DDFF;">}</span></span>
<span class="line"></span></code></pre></div></li><li><p>使用的地方</p><div class="language-csharp"><button title="Copy Code" class="copy"></button><span class="lang">csharp</span><pre class="shiki material-theme-palenight" tabindex="0"><code><span class="line"><span style="color:#BABED8;">CDLWork</span><span style="color:#89DDFF;">.</span><span style="color:#BABED8;">Instance</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">AddTask</span><span style="color:#89DDFF;">(</span><span style="color:#BABED8;">task</span><span style="color:#89DDFF;">);</span></span>
<span class="line"></span></code></pre></div></li></ul><p>这样就明显的看出问题了，外层添加任务使用一个 CDLWork 单例对象，循环调用 CDLWork 的 Update 又是另外一个实例对象，这也就可以解释为啥 update 刷新不到任务了。</p><h1 id="总结" tabindex="-1">总结 <a class="header-anchor" href="#总结" aria-hidden="true">#</a></h1><ul><li>自己明显的发现问题，采用回避的方式处理（偷懒），问题终究最后会暴露出来，而导致耗费更多的时间（<strong>提醒：以后千万不要用这种态度处理问题，别学我</strong>）</li></ul>`,18),e=[o];function t(c,r,D,y,F,B){return a(),n("div",null,e)}const E=s(p,[["render",t]]);export{A as __pageData,E as default};
